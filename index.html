<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WTP Airlangga | Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--primary:#2c3e50;--accent:#3498db;--bg:#f4f6f9;--card:#fff;--text:#333;--safe:#27ae60;--warn:#f39c12;--danger:#c0392b}
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);margin:0;display:flex;min-height:100vh;color:var(--text)}
    .sidebar{width:250px;background:var(--primary);color:#fff;padding:20px;display:flex;flex-direction:column}
    .sidebar h2{font-size:1.1rem;margin:0 0 30px;display:flex;align-items:center;gap:10px}
    .nav-item{padding:12px;border-radius:8px;margin-bottom:8px;cursor:default}
    .main{flex:1;padding:24px;overflow:auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .dashboard-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .card-header{font-size:0.85rem;color:#768487;margin-bottom:8px;font-weight:600;text-transform:uppercase}
    .card-value{font-size:2.4rem;font-weight:700;color:var(--primary)}
    .muted{color:#666;font-size:0.9rem}
    .chart-row{display:grid;grid-template-columns:1fr 2fr;gap:20px}
    .gauge-wrapper{position:relative;height:250px;display:flex;align-items:center;justify-content:center}
    .gauge-label-center{position:absolute;top:58%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .gl-val{font-size:2rem;font-weight:700}
    .gl-unit{font-size:0.9rem;color:#7f8c8d}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;color:#fff;font-weight:700}
    .footer-note{font-size:0.85rem;color:#999;margin-top:14px}
    @media (max-width:900px){
      body{flex-direction:column}
      .sidebar{width:100%;flex-direction:row;align-items:center;padding:12px;gap:12px}
      .dashboard-grid,.chart-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2><i class="fas fa-water"></i> WTP Dashboard</h2>
    <div class="muted" style="font-size:0.9rem">Status: <strong id="connBadge">Connecting...</strong></div>
    <div style="margin-top:auto" class="footer-note">Built for ESP32 → Firebase RTDB</div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 style="margin:0">Turbidity Monitoring</h1>
        <div class="muted" id="timestamp">Waiting for data...</div>
      </div>
      <div>
        <button id="btnForceAuth" style="padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer">Force Sign-in</button>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card">
        <div class="card-header">Sensor Voltage</div>
        <div>
          <span class="card-value" id="numVoltage">--</span>
          <span class="muted" style="margin-left:8px">Volt</span>
        </div>
      </div>

      <div class="card" id="statusCard" style="border-left:8px solid var(--safe)">
        <div class="card-header">Kondisi Air</div>
        <h3 id="txtStatus" style="margin:8px 0;font-size:1.2rem">--</h3>
        <div class="status-badge" id="badgeStatus" style="background:#999">Loading</div>
      </div>

      <div class="card">
        <div class="card-header">Deskripsi</div>
        <p id="txtDesc" class="muted">Menunggu data...</p>
      </div>
    </div>

    <div class="chart-row">
      <div class="card">
        <div class="card-header">Analog Meter</div>
        <div class="gauge-wrapper">
          <canvas id="gaugeChart"></canvas>
          <div class="gauge-label-center">
            <span class="gl-val" id="gaugeVal">0.00</span>
            <span class="gl-unit">VDC</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Riwayat Kekeruhan (Realtime)</div>
        <div style="height:300px"><canvas id="historyChart"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <div class="card-header">Raw JSON (latest /sensors)</div>
      <pre id="raw" style="white-space:pre-wrap;max-height:140px;overflow:auto;margin:0">-</pre>
    </div>

  </main>

  <!-- Firebase compat SDK (safest for quick pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDuCX-dqHQR8oOEB48De23e7nW-Y8DfGlY",
      authDomain: "wtp4-1bb28.firebaseapp.com",
      databaseURL: "https://wtp4-1bb28-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wtp4-1bb28",
      storageBucket: "wtp4-1bb28.appspot.com",
      messagingSenderId: "201479538168",
      appId: "1:201479538168:web:45057248c4f694be0c020d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const connBadge = document.getElementById('connBadge');
    const numVoltage = document.getElementById('numVoltage');
    const txtStatus = document.getElementById('txtStatus');
    const badgeStatus = document.getElementById('badgeStatus');
    const txtDesc = document.getElementById('txtDesc');
    const gaugeVal = document.getElementById('gaugeVal');
    const rawEl = document.getElementById('raw');
    const timestampEl = document.getElementById('timestamp');

    // ---------- CHARTS SETUP ----------
    const ctxG = document.getElementById('gaugeChart').getContext('2d');
    const gaugeChart = new Chart(ctxG, {
      type: 'doughnut',
      data: {
        labels:['val','rest'],
        datasets:[{data:[0,3.3], backgroundColor:['#2c3e50','#ecf0f1'], borderWidth:0, circumference:180, rotation:270, cutout:'80%'}]
      },
      options:{responsive:true,maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{enabled:false}}}
    });

    const ctxH = document.getElementById('historyChart').getContext('2d');
    const gradient = ctxH.createLinearGradient(0,0,0,300);
    gradient.addColorStop(0,'rgba(52,152,219,0.35)');
    gradient.addColorStop(1,'rgba(52,152,219,0)');
    const historyChart = new Chart(ctxH, {
      type:'line',
      data:{labels:[], datasets:[{label:'Voltage', data:[], borderColor:'#3498db', backgroundColor:gradient, fill:true, tension:0.35}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:3.5}}}
    });

    // ---------- HELPERS ----------
    function setStatusColor(vol){
      let color = getComputedStyle(document.documentElement).getPropertyValue('--safe');
      if(vol <= 0.5) color = '#27ae60';
      else if(vol <= 2.5) color = '#f39c12';
      else color = '#c0392b';
      document.getElementById('statusCard').style.borderLeftColor = color;
      badgeStatus.style.backgroundColor = color;
      gaugeChart.data.datasets[0].backgroundColor[0] = color;
      gaugeChart.update();
    }

    function updateHistoryLabel(t, v){
      historyChart.data.labels.push(t);
      historyChart.data.datasets[0].data.push(v);
      if(historyChart.data.labels.length > 30){
        historyChart.data.labels.shift(); historyChart.data.datasets[0].data.shift();
      }
      historyChart.update();
    }

    // ---------- AUTH (try auto anonymous sign-in) ----------
    connBadge.innerText = 'connecting...';
    auth.signInAnonymously()
      .then(() => {
        connBadge.innerText = 'signed in (anonymous)';
      })
      .catch(err => {
        console.error('Auth err', err);
        connBadge.innerText = 'auth error';
        // allow manual trigger
      });

    document.getElementById('btnForceAuth').addEventListener('click', () => {
      auth.signInAnonymously().then(()=>connBadge.innerText='signed in (anonymous)').catch(e=>{connBadge.innerText='auth error'; console.error(e)});
    });

    // ---------- DATABASE LISTENER ----------
    // Your ESP32 writes to /sensors with nested structure:
    // /sensors/turbidity/voltage
    // /sensors/turbidity/level
    // /sensors/turbidity/description
    // /sensors/ultrasonic/cm
    // /sensors/flow/flow_lpm
    // /sensors/flow/total_l
    const sensorsRef = db.ref('/sensors');

    sensorsRef.on('value', snapshot => {
      const data = snapshot.val();
      rawEl.innerText = JSON.stringify(data, null, 2);

      // TURBIDITY
      const turb = data && data.turbidity ? data.turbidity : null;
      const ultr = data && data.ultrasonic ? data.ultrasonic : null;
      const flow = data && data.flow ? data.flow : null;

      if(turb){
        const v = Number(turb.voltage) || 0;
        numVoltage.innerText = v.toFixed(2);
        gaugeVal.innerText = v.toFixed(2);
        txtStatus.innerText = (turb.level) ? turb.level : '—';
        txtDesc.innerText = (turb.description) ? turb.description : '-';
        setStatusColor(v);

        // push history
        const t = new Date().toLocaleTimeString();
        updateHistoryLabel(t, v);
      } else {
        numVoltage.innerText = '--';
        gaugeVal.innerText = '0.00';
        txtStatus.innerText = '--';
      }

      // ULTRASONIC & FLOW not shown as major cards here but available
      if(ultr) console.log('ultrasonic cm', ultr.cm);
      if(flow) console.log('flow', flow.flow_lpm, flow.total_l);

      timestampEl.innerText = 'Last Update: ' + new Date().toLocaleString();
    }, err => {
      console.error('DB read error', err);
      connBadge.innerText = 'db read error';
      rawEl.innerText = 'DB read error: ' + (err && err.message ? err.message : String(err));
    });

    // quick REST check if needed (debug)
    // fetch('https://wtp4-1bb28-default-rtdb.asia-southeast1.firebasedatabase.app/.json').then(r=>r.text()).then(t=>console.log('rest root', t)).catch(e=>console.warn(e));
  </script>
</body>
</html>
