<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WTP Airlangga | Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--primary:#2c3e50;--accent:#3498db;--bg:#f4f6f9;--card:#fff;--text:#333;--safe:#27ae60;--warn:#f39c12;--danger:#c0392b}
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);margin:0;display:flex;min-height:100vh;color:var(--text)}
    .sidebar{width:250px;background:var(--primary);color:#fff;padding:20px;display:flex;flex-direction:column}
    .sidebar h2{font-size:1.1rem;margin:0 0 30px;display:flex;align-items:center;gap:10px}
    .main{flex:1;padding:24px;overflow:auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .dashboard-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .card-header{font-size:0.85rem;color:#768487;margin-bottom:8px;font-weight:600;text-transform:uppercase}
    .card-value{font-size:2.4rem;font-weight:700;color:var(--primary)}
    .muted{color:#666;font-size:0.9rem}
    .chart-row{display:grid;grid-template-columns:1fr 2fr;gap:20px}
    .gauge-wrapper{position:relative;height:250px;display:flex;align-items:center;justify-content:center}
    .gauge-label-center{position:absolute;top:58%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .gl-val{font-size:2rem;font-weight:700}
    .gl-unit{font-size:0.9rem;color:#7f8c8d}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;color:#fff;font-weight:700}
    .footer-note{font-size:0.85rem;color:#999;margin-top:14px}
    @media (max-width:900px){
      body{flex-direction:column}
      .sidebar{width:100%;flex-direction:row;align-items:center;padding:12px;gap:12px}
      .dashboard-grid,.chart-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2><i class="fas fa-water"></i> WTP Dashboard</h2>
    <div class="muted" style="font-size:0.9rem">Status: <strong id="connBadge">Connecting...</strong></div>
    <div style="margin-top:auto" class="footer-note">Built for ESP32 â†’ Firebase RTDB</div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 style="margin:0">Turbidity Monitoring</h1>
        <div class="muted" id="timestamp">Waiting for data...</div>
      </div>
    </div>

    <div class="dashboard-grid">

      <!-- FLOW CARD -->
      <div class="card">
        <div class="card-header">Flow Sekarang</div>
        <div>
          <span class="card-value" id="numFlow">--</span>
          <span class="muted" style="margin-left:8px">L/min</span>
        </div>
        <div style="margin-top:8px;color:#666">
          Total: <strong id="totalFlow">--</strong> L
        </div>
      </div>

      <!-- STATUS CARD -->
      <div class="card" id="statusCard" style="border-left:8px solid var(--safe)">
        <div class="card-header">Kondisi Air</div>
        <h3 id="txtStatus" style="margin:8px 0;font-size:1.2rem">--</h3>
        <div class="status-badge" id="badgeStatus" style="background:#999">Loading</div>
      </div>

      <div class="card">
        <div class="card-header">Deskripsi</div>
        <p id="txtDesc" class="muted">Menunggu data...</p>
      </div>

    </div>

    <div class="chart-row">
      <!-- GAUGE (Ultrasonic Level) -->
      <div class="card">
        <div class="card-header">Level (Ultrasonic)</div>
        <div class="gauge-wrapper">
          <canvas id="gaugeChart"></canvas>
          <div class="gauge-label-center">
            <span class="gl-val" id="gaugeVal">0</span>
            <span class="gl-unit">cm</span>
          </div>
        </div>
      </div>

      <!-- TURBIDITY HISTORY GRAPH -->
      <div class="card">
        <div class="card-header">Riwayat Kekeruhan (Realtime)</div>
        <div style="height:300px"><canvas id="historyChart"></canvas></div>
      </div>
    </div>

  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDuCX-dqHQR8oOEB48De23e7nW-Y8DfGlY",
      authDomain: "wtp4-1bb28.firebaseapp.com",
      databaseURL: "https://wtp4-1bb28-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wtp4-1bb28",
      storageBucket: "wtp4-1bb28.appspot.com",
      messagingSenderId: "201479538168",
      appId: "1:201479538168:web:45057248c4f694be0c020d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const connBadge = document.getElementById('connBadge');
    const numFlow = document.getElementById('numFlow');
    const totalFlow = document.getElementById('totalFlow');
    const txtStatus = document.getElementById('txtStatus');
    const badgeStatus = document.getElementById('badgeStatus');
    const txtDesc = document.getElementById('txtDesc');
    const gaugeVal = document.getElementById('gaugeVal');
    const timestampEl = document.getElementById('timestamp');

    // ---------- CHART SETUP ----------
    const maxUltrasonic = 300;
    const ctxG = document.getElementById('gaugeChart').getContext('2d');
    const gaugeChart = new Chart(ctxG, {
      type: 'doughnut',
      data: {labels:['val','rest'], datasets:[{data:[0,maxUltrasonic],backgroundColor:['#2c3e50','#ecf0f1'],borderWidth:0,circumference:180,rotation:270,cutout:'80%'}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}}}
    });

    const ctxH = document.getElementById('historyChart').getContext('2d');
    const gradient = ctxH.createLinearGradient(0,0,0,300);
    gradient.addColorStop(0,'rgba(52,152,219,0.35)');
    gradient.addColorStop(1,'rgba(52,152,219,0)');
    const historyChart = new Chart(ctxH,{
      type:'line',
      data:{labels:[],datasets:[{label:'Turbidity (V)',data:[],borderColor:'#3498db',backgroundColor:gradient,fill:true,tension:0.35}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:3.5}}}
    });

    function setStatusColor(v){
      let c='#27ae60';
      if(v <= 0.5) c='#27ae60';
      else if(v <= 2.5) c='#f39c12';
      else c='#c0392b';
      document.getElementById('statusCard').style.borderLeftColor=c;
      badgeStatus.style.backgroundColor=c;
    }

    function addHistory(t,v){
      historyChart.data.labels.push(t);
      historyChart.data.datasets[0].data.push(v);
      if(historyChart.data.labels.length>30){
        historyChart.data.labels.shift();
        historyChart.data.datasets[0].data.shift();
      }
      historyChart.update();
    }

    // ---------- AUTH auto ----------
    auth.signInAnonymously()
      .then(()=>connBadge.innerText='Online')
      .catch(err=>{connBadge.innerText='Auth Error';console.error(err)});

    // ---------- DATABASE LISTENER ----------
    db.ref('/sensors').on('value',snap=>{
      const data=snap.val();
      const turb=data?.turbidity;
      const ultr=data?.ultrasonic;
      const flow=data?.flow;

      // FLOW
      if(flow){
        numFlow.innerText=(+flow.flow_lpm).toFixed(2);
        totalFlow.innerText=(+flow.total_l).toFixed(3);
      }

      // TURBIDITY
      if(turb){
        const v=+turb.voltage || 0;
        txtStatus.innerText=turb.level || '--';
        txtDesc.innerText=turb.description || '-';
        setStatusColor(v);
        addHistory(new Date().toLocaleTimeString(), v);
      }

      // ULTRASONIC GAUGE
      if(ultr){
        let cm=+ultr.cm;
        if(cm<0 || isNaN(cm)) cm=0;
        cm=Math.min(cm,maxUltrasonic);
        gaugeVal.innerText=cm.toFixed(0);
        gaugeChart.data.datasets[0].data=[cm,maxUltrasonic-cm];
        gaugeChart.update();
      }

      timestampEl.innerText="Last Update: "+new Date().toLocaleString();
    });

  </script>
</body>
</html>
